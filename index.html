<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中小学积分管理系统</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; }
        body { font-family: '微软雅黑', sans-serif; background: #f5f6fa; margin: 0; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .file-upload { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .file-upload input[type="text"], 
        .file-upload input[type="number"] { padding: 8px; margin-right: 10px; width: 200px; }
        .grade-section { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #e0e0e0; padding: 12px; text-align: left; }
        th { background: var(--primary); color: white; font-weight: 500; }
        tr:nth-child(even) { background: #f8f9fa; }
        .score-btn { padding: 6px 12px; margin: 0 4px; border: none; border-radius: 4px; cursor: pointer; transition: opacity 0.2s; }
        .score-btn:hover { opacity: 0.9; }
        .add-btn { background: #27ae60; color: white; }
        .exchange-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* 折叠与滚动样式 */
        .collapsible {
            cursor: pointer;
            padding: 12px 15px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .collapsible:hover { background: #34495e; }
        .collapsible::after {
            content: "▼";
            font-size: 0.8em;
            transition: transform 0.3s;
        }
        .collapsible.active::after {
            transform: rotate(180deg);
        }
        .class-content {
            max-height: 0;
            overflow-y: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .class-content.active {
            max-height: 600px;
            overflow-y: auto;
        }
        .student-count {
            font-size: 0.9em;
            opacity: 0.8;
            margin-left: 10px;
        }

        /* 加载提示和错误样式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .error-details {
            background: #f8d7da;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .error-line {
            color: #721c24;
            font-family: monospace;
            font-size: 0.9em;
            margin: 5px 0;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="file-upload">
            <input type="file" id="fileInput" accept=".xlsx,.xls,.txt">
            <button onclick="importData()">导入名单</button>
            <span style="margin-left:15px;color:#666">支持Excel或TXT文件（格式：班级@姓名）</span>
        </div>

        <div class="file-upload">
            <input type="text" id="newClass" placeholder="年级班级（如：一年级1班）">
            <input type="text" id="newName" placeholder="学生姓名">
            <button class="add-btn" onclick="addStudent()">添加学生</button>
        </div>

        <div id="gradeContainer"></div>

        <div class="exchange-panel">
            <h3 style="margin-top:0">奖品管理</h3>
            <div style="margin-bottom:15px">
                <input type="text" id="prizeName" placeholder="奖品名称" style="width:180px">
                <input type="number" id="prizePoints" placeholder="所需积分" style="width:120px">
                <input type="number" id="prizeStock" placeholder="库存数量" style="width:120px">
                <button class="add-btn" onclick="addPrize()">添加奖品</button>
            </div>
            <div id="prizeList"></div>
        </div>
    </div>

<script>
const CLOUDFLARE_API_URL = 'https://banji.446617.workers.dev/';
let classData = {}; 
let prizes = [];

// 数据加载（增强版）
async function loadData() {
    showLoading();
    try {
        classData = {};
        
        // 获取班级列表（防缓存）
        const classListRes = await fetch(`${CLOUDFLARE_API_URL}/classes?t=${Date.now()}`);
        if (!classListRes.ok) throw new Error('班级列表加载失败');
        const classList = await classListRes.json();
        
        // 并行加载班级数据
        const classDataArray = await Promise.all(
            classList.map(async className => {
                const res = await fetch(`${CLOUDFLARE_API_URL}/class/${encodeURIComponent(className)}?t=${Date.now()}`);
                return res.ok ? res.json() : null;
            })
        );
        
        // 处理有效数据
        classDataArray.forEach(data => {
            if (!data) return;
            classData[data.className] = {
                students: data.students || [],
                collapseState: data.collapseState ?? false
            };
        });
        
        // 加载奖品数据
        const prizesRes = await fetch(`${CLOUDFLARE_API_URL}/prizes?t=${Date.now()}`);
        prizes = prizesRes.ok ? await prizesRes.json() : [];
        
    } catch (e) {
        console.error('加载失败:', e);
        showMessage('数据加载失败，请刷新重试', 'error');
    } finally {
        hideLoading();
        renderAll();
        renderPrizes();
    }
}

// 数据保存（增强错误处理）
async function saveClassData(className) {
    try {
        const res = await fetch(`${CLOUDFLARE_API_URL}/class/${encodeURIComponent(className)}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                className,
                students: classData[className].students,
                collapseState: classData[className].collapseState
            })
        });
        if (!res.ok) throw new Error('保存失败');
    } catch (e) {
        console.error('保存失败:', e);
        showMessage('自动保存失败，请检查网络', 'error');
    }
}

// 学生管理功能
async function addStudent() {
    const className = document.getElementById('newClass').value.trim();
    const name = document.getElementById('newName').value.trim();
    if (!className || !name) {
        showMessage('请填写完整信息', 'warning');
        return;
    }

    try {
        if (!classData[className]) {
            await fetch(`${CLOUDFLARE_API_URL}/classes`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ className })
            });
            classData[className] = { students: [], collapseState: false };
        }
        
        classData[className].students.push({ name, score: 0 });
        await saveClassData(className);
        renderAll();
        showMessage('学生添加成功', 'success');
    } catch (e) {
        console.error('添加失败:', e);
        showMessage('添加学生失败，请重试', 'error');
    }
}

async function adjustScore(className, index, delta) {
    const student = classData[className].students[index];
    student.score = Math.max(0, student.score + delta);
    await saveClassData(className);
    renderAll();
}

async function deleteStudent(className, index) {
    classData[className].students.splice(index, 1);
    await saveClassData(className);
    renderAll();
}

// 奖品管理功能
async function addPrize() {
    const name = document.getElementById('prizeName').value.trim();
    const points = parseInt(document.getElementById('prizePoints').value);
    const stock = parseInt(document.getElementById('prizeStock').value);

    if (!name || isNaN(points) || isNaN(stock)) {
        showMessage('请填写完整的奖品信息', 'warning');
        return;
    }

    try {
        prizes.push({ name, points, stock });
        await fetch(`${CLOUDFLARE_API_URL}/prizes`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(prizes)
        });
        renderPrizes();
        showMessage('奖品添加成功', 'success');
    } catch (e) {
        console.error('添加失败:', e);
        showMessage('奖品添加失败，请重试', 'error');
    }
}

function renderPrizes() {
    document.getElementById('prizeList').innerHTML = prizes.map((p, i) => `
        <div style="margin:10px; padding:10px; border:1px solid #ddd">
            ${p.name} (需${p.points}分) 剩余：${p.stock}件
            <button onclick="exchangePrize(${i})">兑换</button>
        </div>
    `).join('');
}

async function exchangePrize(index) {
    if (prizes[index].stock <= 0) {
        showMessage('该奖品已无库存', 'warning');
        return;
    }

    const studentName = prompt("请输入兑换学生姓名：");
    const className = prompt("请输入所在班级：");
    if (!studentName || !className) return;

    const classInfo = classData[className];
    if (!classInfo) {
        showMessage('班级不存在', 'error');
        return;
    }

    const student = classInfo.students.find(s => s.name === studentName);
    if (!student) {
        showMessage('找不到该学生', 'error');
        return;
    }

    if (student.score < prizes[index].points) {
        showMessage('积分不足，无法兑换', 'warning');
        return;
    }

    if (confirm(`确定扣除${prizes[index].points}积分兑换${prizes[index].name}吗？`)) {
        try {
            student.score -= prizes[index].points;
            prizes[index].stock--;
            
            await Promise.all([
                saveClassData(className),
                fetch(`${CLOUDFLARE_API_URL}/prizes`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(prizes)
                })
            ]);
            
            renderAll();
            renderPrizes();
            showMessage('兑换成功', 'success');
        } catch (e) {
            console.error('兑换失败:', e);
            showMessage('兑换失败，请重试', 'error');
        }
    }
}

// 文件处理（完整版）
function importData() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) {
        showMessage('请先选择文件', 'warning');
        return;
    }

    // 文件类型验证
    if (!file.name.match(/\.(xlsx|xls|txt)$/i)) {
        showMessage('仅支持.xlsx, .xls, .txt文件', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = async function(e) {
        showLoading();
        let errorLines = [];
        
        try {
            if (file.name.endsWith('.txt')) {
                errorLines = processTXT(e.target.result);
            } else {
                errorLines = processExcel(e.target.result);
            }

            if (errorLines.length > 0) {
                showParseErrors(errorLines);
            } else {
                await Promise.all(Object.keys(classData).map(saveClassData));
                await loadData();
                showMessage(`成功导入${Object.values(classData).reduce((a,b) => a + b.students.length, 0)}条记录`, 'success');
            }
        } catch (e) {
            console.error('导入失败:', e);
            showMessage('文件解析失败，请检查格式', 'error');
        } finally {
            hideLoading();
        }
    };
    
    file.name.endsWith('.txt') 
        ? reader.readAsText(file, 'UTF-8')
        : reader.readAsArrayBuffer(file);
}

function processTXT(data) {
    const errorLines = [];
    data.split('\n').forEach((line, index) => {
        line = line.trim();
        if (!line) return;

        try {
            const [className, name] = line.split(/[@,]/).map(s => s.trim());
            if (!className || !name) throw new Error('格式错误');

            if (!classData[className]) {
                classData[className] = { students: [], collapseState: false };
            }
            classData[className].students.push({ name, score: 0 });
        } catch (e) {
            errorLines.push({
                lineNumber: index + 1,
                content: line,
                error: e.message
            });
        }
    });
    return errorLines;
}

function processExcel(data) {
    const errorLines = [];
    try {
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});

        // 自动检测列索引
        const header = rows[0].map(h => String(h).trim().toLowerCase());
        const classCol = header.findIndex(h => h.includes('班级'));
        const nameCol = header.findIndex(h => h.includes('姓名'));
        
        if (classCol === -1 || nameCol === -1) {
            throw new Error('找不到必需的"班级"和"姓名"列');
        }

        rows.slice(1).forEach((row, index) => {
            try {
                const className = String(row[classCol]).trim();
                const name = String(row[nameCol]).trim();
                if (!className || !name) throw new Error('空值');

                if (!classData[className]) {
                    classData[className] = { students: [], collapseState: false };
                }
                classData[className].students.push({ name, score: 0 });
            } catch (e) {
                errorLines.push({
                    lineNumber: index + 2,
                    content: JSON.stringify(row),
                    error: e.message
                });
            }
        });
    } catch (e) {
        throw new Error(`Excel解析错误: ${e.message}`);
    }
    return errorLines;
}

// 界面渲染
function renderAll() {
    let html = '';
    const grades = new Map();
    
    Object.keys(classData).forEach(className => {
        const grade = className.replace(/\d+/g, '');
        if (!grades.has(grade)) grades.set(grade, []);
        grades.get(grade).push(className);
    });

    grades.forEach((classes, grade) => {
        html += `<div class="grade-section"><h3>${grade}</h3>`;
        classes.forEach(className => {
            const { students, collapseState } = classData[className];
            html += `
            <div class="class-container">
                <div class="collapsible ${collapseState ? '' : 'active'}" 
                     onclick="toggleCollapse('${className}')">
                    ${className}
                    <span class="student-count">(${students.length}人)</span>
                </div>
                <div class="class-content ${collapseState ? '' : 'active'}" 
                     id="${className}-content">
                    <table>
                        ${students.map((s, i) => `
                        <tr>
                            <td>${s.name}</td>
                            <td>${s.score}分</td>
                            <td>
                                <button class="score-btn" style="background:#27ae60" 
                                    onclick="adjustScore('${className}', ${i}, 1)">+1</button>
                                <button class="score-btn" style="background:#e74c3c" 
                                    onclick="adjustScore('${className}', ${i}, -1)">-1</button>
                                <button class="score-btn" 
                                    onclick="deleteStudent('${className}', ${i})">删除</button>
                            </td>
                        </tr>`).join('')}
                    </table>
                </div>
            </div>`;
        });
        html += '</div>';
    });
    
    document.getElementById('gradeContainer').innerHTML = html;
}

// 折叠功能
async function toggleCollapse(className) {
    const content = document.getElementById(`${className}-content`);
    const header = content.previousElementSibling;
    classData[className].collapseState = !classData[className].collapseState;
    header.classList.toggle('active');
    content.classList.toggle('active');
    await saveClassData(className);
}

// UI辅助功能
function showMessage(content, type='info', timeout=3000) {
    const colors = { info: '#3498db', success: '#2ecc71', warning: '#f1c40f', error: '#e74c3c' };
    const el = document.createElement('div');
    el.style = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${colors[type]};
        color: white;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
    `;
    el.innerHTML = typeof content === 'string' ? content : content.outerHTML;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), timeout);
}

function showParseErrors(errors) {
    const errorHtml = `
        <div class="error-details">
            <div>发现${errors.length}处格式错误：</div>
            ${errors.map(e => `
                <div class="error-line">
                    <b>第${e.lineNumber}行</b>: 
                    ${e.error} (${e.content.length > 50 ? e.content.substring(0,50)+'...' : e.content})
                </div>
            `).join('')}
        </div>
    `;
    showMessage(errorHtml, 'error', 10000);
}

function showLoading() {
    const el = document.createElement('div');
    el.className = 'loading-overlay';
    el.innerHTML = `<div style="font-size:1.2em">加载中...</div>`;
    document.body.appendChild(el);
}

function hideLoading() {
    const el = document.querySelector('.loading-overlay');
    if (el) el.remove();
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    setInterval(() => {
        Promise.all(Object.keys(classData).map(saveClassData));
    }, 300000); // 5分钟自动保存
});
</script>
</body>
</html>
