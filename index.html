<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中小学积分管理系统</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; }
        body { font-family: '微软雅黑', sans-serif; background: #f5f6fa; margin: 0; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .file-upload { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .file-upload input[type="text"], 
        .file-upload input[type="number"] { padding: 8px; margin-right: 10px; width: 200px; }
        .grade-section { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #e0e0e0; padding: 12px; text-align: left; }
        th { background: var(--primary); color: white; font-weight: 500; }
        tr:nth-child(even) { background: #f8f9fa; }
        .score-btn { padding: 6px 12px; margin: 0 4px; border: none; border-radius: 4px; cursor: pointer; transition: opacity 0.2s; }
        .score-btn:hover { opacity: 0.9; }
        .add-btn { background: #27ae60; color: white; }
        .exchange-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* 折叠与滚动样式 */
        .collapsible {
            cursor: pointer;
            padding: 12px 15px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .collapsible:hover { background: #34495e; }
        .collapsible::after {
            content: "▼";
            font-size: 0.8em;
            transition: transform 0.3s;
        }
        .collapsible.active::after {
            transform: rotate(180deg);
        }
        .class-content {
            max-height: 0;
            overflow-y: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .class-content.active {
            max-height: 600px;  /* 可滚动区域高度 */
            overflow-y: auto;
        }
        .student-count {
            font-size: 0.9em;
            opacity: 0.8;
            margin-left: 10px;
        }

        /* 加载提示 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="file-upload">
            <input type="file" id="fileInput" accept=".xlsx,.xls,.txt">
            <button onclick="importData()">导入名单</button>
            <span style="margin-left:15px;color:#666">支持Excel或TXT文件（格式：班级@姓名）</span>
        </div>

        <div class="file-upload">
            <input type="text" id="newClass" placeholder="年级班级（如：一年级1班）">
            <input type="text" id="newName" placeholder="学生姓名">
            <button class="add-btn" onclick="addStudent()">添加学生</button>
        </div>

        <div id="gradeContainer"></div>

        <div class="exchange-panel">
            <h3 style="margin-top:0">奖品管理</h3>
            <div style="margin-bottom:15px">
                <input type="text" id="prizeName" placeholder="奖品名称" style="width:180px">
                <input type="number" id="prizePoints" placeholder="所需积分" style="width:120px">
                <input type="number" id="prizeStock" placeholder="库存数量" style="width:120px">
                <button class="add-btn" onclick="addPrize()">添加奖品</button>
            </div>
            <div id="prizeList"></div>
        </div>
    </div>

<script>
// Cloudflare配置
const CLOUDFLARE_API_URL = 'https://banji.446617.workers.dev/';
let classData = {}; 
let prizes = [];

// 增强版数据加载
async function loadData() {
    showLoading();
    try {
        // 清除旧数据
        classData = {};
        
        // 获取班级列表（带缓存刷新）
        const classListRes = await fetch(`${CLOUDFLARE_API_URL}/classes?t=${Date.now()}`);
        if (!classListRes.ok) throw new Error('班级列表加载失败');
        const classList = await classListRes.json();
        
        // 并行加载班级数据
        const classDataArray = await Promise.all(
            classList.map(async className => {
                const res = await fetch(`${CLOUDFLARE_API_URL}/class/${encodeURIComponent(className)}?t=${Date.now()}`);
                return res.ok ? res.json() : null;
            })
        );
        
        // 处理有效数据
        classDataArray.forEach(data => {
            if (!data) return;
            classData[data.className] = {
                students: data.students || [],
                collapseState: data.collapseState ?? false
            };
        });
        
        // 加载奖品数据
        const prizesRes = await fetch(`${CLOUDFLARE_API_URL}/prizes?t=${Date.now()}`);
        prizes = prizesRes.ok ? await prizesRes.json() : [];
        
    } catch (e) {
        console.error('加载失败:', e);
        showMessage('数据加载失败，请刷新重试', 'error');
    } finally {
        hideLoading();
        renderAll();
        renderPrizes();
    }
}

// 增强版保存功能
async function saveClassData(className) {
    try {
        const res = await fetch(`${CLOUDFLARE_API_URL}/class/${encodeURIComponent(className)}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                className,
                students: classData[className].students,
                collapseState: classData[className].collapseState
            })
        });
        if (!res.ok) throw new Error('保存失败');
    } catch (e) {
        console.error('保存失败:', e);
        showMessage('自动保存失败，请检查网络', 'error');
    }
}

// 核心功能
async function addStudent() {
    const className = document.getElementById('newClass').value;
    const name = document.getElementById('newName').value;
    if (className && name) {
        if (!classData[className]) await addNewClass(className);
        classData[className].students.push({ name, score: 0 });
        await saveClassData(className);
        renderAll();
    }
}

async function adjustScore(className, index, delta) {
    classData[className].students[index].score += delta;
    await saveClassData(className);
    renderAll();
}

async function deleteStudent(className, index) {
    classData[className].students.splice(index, 1);
    await saveClassData(className);
    renderAll();
}

// 奖品管理
async function addPrize() {
    prizes.push({
        name: document.getElementById('prizeName').value,
        points: parseInt(document.getElementById('prizePoints').value),
        stock: parseInt(document.getElementById('prizeStock').value)
    });
    await fetch(`${CLOUDFLARE_API_URL}/prizes`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(prizes)
    });
    renderPrizes();
}

function renderPrizes() {
    document.getElementById('prizeList').innerHTML = prizes.map((p, i) => `
        <div style="margin:10px; padding:10px; border:1px solid #ddd">
            ${p.name} (需${p.points}分) 剩余：${p.stock}件
            <button onclick="exchangePrize(${i})">兑换</button>
        </div>
    `).join('');
}

async function exchangePrize(index) {
    if (prizes[index].stock > 0) {
        const studentName = prompt("请输入兑换学生姓名：");
        const className = prompt("请输入所在班级：");
        if (classData[className]) {
            const student = classData[className].students.find(s => s.name === studentName);
            if (student && confirm(`确认扣除${prizes[index].points}积分兑换${prizes[index].name}？`)) {
                if (student.score >= prizes[index].points) {
                    student.score -= prizes[index].points;
                    prizes[index].stock--;
                    await Promise.all([
                        saveClassData(className),
                        fetch(`${CLOUDFLARE_API_URL}/prizes`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(prizes)
                        })
                    ]);
                    renderAll();
                    renderPrizes();
                } else {
                    alert('积分不足！');
                }
            }
        }
    }
}
// 文件处理（增强版）
function importData() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) {
        showMessage('请先选择文件', 'warning');
        return;
    }

    const reader = new FileReader();
    reader.onload = async function(e) {
        showLoading();
        try {
            if (file.name.endsWith('.txt')) {
                processTXT(e.target.result);
            } else {
                processExcel(e.target.result);
            }
            await Promise.all(Object.keys(classData).map(saveClassData));
            await loadData();  // 强制刷新数据
            showMessage('导入成功', 'success');
        } catch (e) {
            console.error('导入失败:', e);
            showMessage('文件解析失败，请检查格式', 'error');
        } finally {
            hideLoading();
        }
    };
    
    file.name.endsWith('.txt') 
        ? reader.readAsText(file) 
        : reader.readAsArrayBuffer(file);
}

// UI辅助功能
function showMessage(text, type='info') {
    const colors = { info: '#3498db', success: '#2ecc71', warning: '#f1c40f', error: '#e74c3c' };
    const el = document.createElement('div');
    el.style = `position:fixed; top:20px; right:20px; padding:12px 20px; background:${colors[type]}; color:white; border-radius:4px;`;
    el.innerText = text;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
}

function showLoading() {
    const el = document.createElement('div');
    el.className = 'loading-overlay';
    el.innerHTML = `<div style="font-size:1.2em">加载中...</div>`;
    document.body.appendChild(el);
}

function hideLoading() {
    const el = document.querySelector('.loading-overlay');
    if (el) el.remove();
}

// 初始化加载
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    // 每5分钟自动保存
    setInterval(() => {
        Promise.all(Object.keys(classData).map(saveClassData));
    }, 300000);
});
</script>
</body>
</html>
