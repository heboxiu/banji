<!-- index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 样式部分保持不变 -->
    <style>
        /* 原有样式代码保持不变 */
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- HTML结构保持不变 -->
    </div>

<script>
// Cloudflare配置
const CLOUDFLARE_API_URL = 'https://banji.446617.workers.dev/';

// 数据存储结构
let classData = {};
let prizes = [];

// 增强版初始化加载
async function loadData() {
    try {
        // 并行请求优化
        const [classListRes, prizesRes] = await Promise.all([
            fetch(`${CLOUDFLARE_API_URL}/classes`),
            fetch(`${CLOUDFLARE_API_URL}/prizes`)
        ]);

        // 处理班级列表
        const classList = await classListRes.json();
        
        // 并行获取班级数据（增加错误处理）
        const classPromises = classList.map(className => 
            fetch(`${CLOUDFLARE_API_URL}/class/${encodeURIComponent(className)}`)
                .then(res => res.json())
                .catch(() => ({ students: [], collapseState: false }))
        );
        
        const classDatas = await Promise.all(classPromises);
        classList.forEach((className, index) => {
            classData[className] = {
                students: classDatas[index].students || [],
                collapseState: classDatas[index].collapseState || false
            };
        });

        // 处理奖品数据
        prizes = await prizesRes.json();
        
    } catch (e) {
        console.error('初始化加载失败:', e);
        alert('数据加载失败，请检查网络连接');
    }
    renderAll();
    renderPrizes();
}

// 修复后的添加学生功能
async function addStudent() {
    const className = document.getElementById('newClass').value.trim();
    const name = document.getElementById('newName').value.trim();
    
    if (!className || !name) {
        alert('请填写完整的班级和学生信息');
        return;
    }

    try {
        // 确保班级存在
        if (!classData[className]) {
            await addNewClass(className);
        }
        
        // 检查重复学生
        const exists = classData[className].students.some(s => s.name === name);
        if (exists) {
            alert('该学生已存在！');
            return;
        }

        // 添加新学生
        classData[className].students.push({ name, score: 0 });
        await saveClassData(className);
        
        // 清空输入框
        document.getElementById('newClass').value = '';
        document.getElementById('newName').value = '';
        
        renderAll();
    } catch (e) {
        console.error('添加学生失败:', e);
        alert('添加失败，请检查控制台');
    }
}

// 增强版添加班级功能
async function addNewClass(className) {
    try {
        const response = await fetch(`${CLOUDFLARE_API_URL}/classes`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ className })
        });
        
        if (!response.ok) throw new Error('班级创建失败');
        
        // 更新本地数据
        classData[className] = {
            students: [],
            collapseState: false
        };
        
        // 重新加载数据保证一致性
        await loadData();
    } catch (e) {
        console.error('创建班级失败:', e);
        throw e;
    }
}

// 保存班级数据（增加重试机制）
async function saveClassData(className) {
    let retries = 3;
    while (retries > 0) {
        try {
            const response = await fetch(`${CLOUDFLARE_API_URL}/class/${encodeURIComponent(className)}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    students: classData[className].students,
                    collapseState: classData[className].collapseState
                })
            });
            if (!response.ok) throw new Error('保存失败');
            return;
        } catch (e) {
            retries--;
            if (retries === 0) throw e;
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
}

// 其他功能保持不变（renderAll、toggleCollapse等）

// 初始化加载
document.addEventListener('DOMContentLoaded', () => {
    loadData().catch(e => {
        console.error('初始化失败:', e);
        alert('系统初始化失败，请刷新页面');
    });
});
</script>
</body>
</html>
