<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å°å­¦ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; }
        body { 
            font-family: 'å¾®è½¯é›…é»‘', sans-serif; 
            background: #f5f6fa; 
            margin: 0; 
            line-height: 1.6;
        }
        .container { 
            max-width: 1200px; 
            margin: 20px auto; 
            padding: 20px; 
        }
        .file-upload { 
            background: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 25px;
        }
        .grade-section { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 25px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
        }
        th, td { 
            border: 1px solid #ecf0f1; 
            padding: 12px 15px; 
            text-align: left; 
            min-width: 120px;
        }
        th { 
            background: var(--primary); 
            color: white; 
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) { 
            background: #f8f9fa; 
        }
        .score-btn { 
            padding: 6px 12px; 
            margin: 0 4px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: opacity 0.2s;
        }
        .score-btn:hover { 
            opacity: 0.85; 
        }
        .add-btn { 
            background: #27ae60; 
            color: white; 
            padding: 8px 16px;
        }
        .exchange-panel { 
            background: #fff; 
            padding: 25px; 
            margin-top: 25px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* ä¼˜åŒ–æŠ˜å å®¹å™¨ */
        .class-container {
            margin: 15px 0;
        }
        .collapsible {
            cursor: pointer;
            padding: 14px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .collapsible:hover { 
            background: #34495e; 
        }
        .collapsible::after {
            content: "â–¼";
            transition: transform 0.3s;
            font-size: 0.9em;
        }
        .collapsible.active::after { 
            transform: rotate(180deg); 
        }

        /* å¢å¼ºæ»šåŠ¨å®¹å™¨ */
        .scrollable-container {
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #ecf0f1;
            border-radius: 0 0 6px 6px;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .student-count {
            font-size: 0.9em;
            opacity: 0.9;
            margin-left: 15px;
        }

        /* æ»šåŠ¨æ¡ä¼˜åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            td, th { padding: 10px; }
            .score-btn { 
                padding: 4px 8px; 
                margin: 2px; 
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="file-upload">
            <input type="file" id="fileInput" accept=".xlsx,.xls,.txt">
            <button onclick="importData()">å¯¼å…¥åå•</button>
            <small>æ”¯æŒExcelæˆ–TXTæ–‡ä»¶ï¼ˆæ ¼å¼ï¼šç­çº§@å§“åï¼‰</small>
        </div>

        <div class="file-upload">
            <input type="text" id="newClass" placeholder="å¹´çº§ç­çº§ï¼ˆå¦‚ï¼šä¸€å¹´çº§1ç­ï¼‰">
            <input type="text" id="newName" placeholder="å­¦ç”Ÿå§“å">
            <button class="add-btn" onclick="addStudent()">æ·»åŠ å­¦ç”Ÿ</button>
        </div>

        <div id="gradeContainer"></div>

        <div class="exchange-panel">
            <h3>ğŸ å¥–å“ç®¡ç†</h3>
            <div style="margin:15px 0">
                <input type="text" id="prizeName" placeholder="å¥–å“åç§°">
                <input type="number" id="prizePoints" placeholder="æ‰€éœ€ç§¯åˆ†" min="1">
                <input type="number" id="prizeStock" placeholder="åº“å­˜æ•°é‡" min="0">
                <button class="add-btn" onclick="addPrize()">æ·»åŠ å¥–å“</button>
            </div>
            <div id="prizeList"></div>
        </div>
    </div>

<script>
const CLOUDFLARE_API_URL = 'https://banji.446617.workers.dev/';
let classData = {};
let prizes = [];

// æ•°æ®åˆå§‹åŒ–
async function loadData() {
    try {
        const [classListRes, prizesRes] = await Promise.all([
            fetch(`${CLOUDFLARE_API_URL}/classes`),
            fetch(`${CLOUDFLARE_API_URL}/prizes`)
        ]);

        if (!classListRes.ok || !prizesRes.ok) throw new Error('æ•°æ®åŠ è½½å¤±è´¥');

        const classList = await classListRes.json();
        const classPromises = classList.map(className => 
            fetch(`${CLOUDFLARE_API_URL}/class/${encodeURIComponent(className)}`)
                .then(res => res.json())
                .catch(() => ({ students: [], collapseState: false }))
        );

        const classDatas = await Promise.all(classPromises);
        classList.forEach((className, index) => {
            classData[className] = {
                students: classDatas[index].students || [],
                collapseState: classDatas[index].collapseState || false
            };
        });

        prizes = await prizesRes.json();
        renderAll();
        renderPrizes();
    } catch (e) {
        console.error('åŠ è½½å¤±è´¥:', e);
        alert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
    }
}

// å­¦ç”Ÿç®¡ç†
async function addStudent() {
    const className = document.getElementById('newClass').value.trim();
    const name = document.getElementById('newName').value.trim();
    
    if (!className || !name) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
    if (!/^[\u4e00-\u9fa5]+\d+ç­$/.test(className)) return alert('ç­çº§æ ¼å¼é”™è¯¯');

    try {
        if (!classData[className]) await addNewClass(className);
        if (classData[className].students.some(s => s.name === name)) {
            return alert('è¯¥å­¦ç”Ÿå·²å­˜åœ¨');
        }

        classData[className].students.push({ name, score: 0 });
        await saveClassData(className);
        document.getElementById('newName').value = '';
        renderAll();
    } catch (e) {
        alert('æ·»åŠ å¤±è´¥: ' + e.message);
    }
}

async function addNewClass(className) {
    const response = await fetch(`${CLOUDFLARE_API_URL}/classes`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ className })
    });
    if (!response.ok) throw new Error('åˆ›å»ºç­çº§å¤±è´¥');
    classData[className] = { students: [], collapseState: false };
}

async function saveClassData(className) {
    await fetch(`${CLOUDFLARE_API_URL}/class/${encodeURIComponent(className)}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(classData[className])
    });
}

// ç§¯åˆ†è°ƒæ•´
async function adjustScore(className, index, delta) {
    const newScore = classData[className].students[index].score + delta;
    if (newScore < 0) return alert('ç§¯åˆ†ä¸èƒ½ä¸ºè´Ÿ');
    classData[className].students[index].score = newScore;
    await saveClassData(className);
    renderAll();
}

async function deleteStudent(className, index) {
    if (!confirm('ç¡®å®šåˆ é™¤è¯¥å­¦ç”Ÿï¼Ÿ')) return;
    classData[className].students.splice(index, 1);
    await saveClassData(className);
    renderAll();
}

// å¥–å“ç®¡ç†
async function addPrize() {
    const prize = {
        name: document.getElementById('prizeName').value.trim(),
        points: parseInt(document.getElementById('prizePoints').value),
        stock: parseInt(document.getElementById('prizeStock').value)
    };
    
    if (!prize.name || isNaN(prize.points) || isNaN(prize.stock)) {
        return alert('è¯·å¡«å†™å®Œæ•´çš„å¥–å“ä¿¡æ¯');
    }

    prizes.push(prize);
    await fetch(`${CLOUDFLARE_API_URL}/prizes`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(prizes)
    });
    renderPrizes();
}

function renderPrizes() {
    document.getElementById('prizeList').innerHTML = prizes.map((p, i) => `
        <div class="prize-item">
            <b>${p.name}</b> 
            <span>${p.points}åˆ†</span> 
            <span>å‰©ä½™: ${p.stock}</span>
            <button onclick="exchangePrize(${i})">å…‘æ¢</button>
        </div>
    `).join('');
}

async function exchangePrize(index) {
    if (prizes[index].stock < 1) return alert('åº“å­˜ä¸è¶³');
    const studentName = prompt("å­¦ç”Ÿå§“åï¼š");
    const className = prompt("æ‰€åœ¨ç­çº§ï¼š");
    
    if (!studentName || !className) return;
    if (!classData[className]) return alert('ç­çº§ä¸å­˜åœ¨');

    const student = classData[className].students.find(s => s.name === studentName);
    if (!student) return alert('å­¦ç”Ÿä¸å­˜åœ¨');
    if (student.score < prizes[index].points) return alert('ç§¯åˆ†ä¸è¶³');

    if (confirm(`ç¡®è®¤ç”¨${prizes[index].points}ç§¯åˆ†å…‘æ¢${prizes[index].name}ï¼Ÿ`)) {
        student.score -= prizes[index].points;
        prizes[index].stock--;
        await Promise.all([
            saveClassData(className),
            fetch(`${CLOUDFLARE_API_URL}/prizes`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(prizes)
            })
        ]);
        renderAll();
        renderPrizes();
    }
}

// æ–‡ä»¶å¤„ç†
function importData() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶');
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            if (file.name.endsWith('.txt')) {
                processTXT(e.target.result);
            } else {
                processExcel(e.target.result);
            }
            await Promise.all(Object.keys(classData).map(saveClassData));
            renderAll();
        } catch (e) {
            alert('æ–‡ä»¶è§£æå¤±è´¥: ' + e.message);
        }
    };
    
    file.name.endsWith('.txt') 
        ? reader.readAsText(file) 
        : reader.readAsArrayBuffer(file);
}

function processTXT(data) {
    data.split('\n').forEach(line => {
        const [className, name] = line.split('@').map(s => s.trim());
        if (className && name) {
            if (!classData[className]) {
                classData[className] = { students: [], collapseState: false };
            }
            classData[className].students.push({ name, score: 0 });
        }
    });
}

function processExcel(data) {
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    XLSX.utils.sheet_to_json(sheet).forEach(row => {
        const className = row.ç­çº§?.trim();
        const name = row.å§“å?.trim();
        if (className && name) {
            if (!classData[className]) {
                classData[className] = { students: [], collapseState: false };
            }
            classData[className].students.push({ name, score: 0 });
        }
    });
}

// ç•Œé¢æ¸²æŸ“
function renderAll() {
    const gradeMap = new Map();
    Object.keys(classData).forEach(className => {
        const grade = className.replace(/\d+/g, '');
        gradeMap.set(grade, [...(gradeMap.get(grade) || [], className]);
    });

    let html = '';
    gradeMap.forEach((classes, grade) => {
        html += `<div class="grade-section"><h2>${grade}</h2>`;
        classes.sort((a,b) => a.match(/\d+/)[0] - b.match(/\d+/)[0]).forEach(className => {
            const { students, collapseState } = classData[className];
            html += `
            <div class="class-container">
                <div class="collapsible ${collapseState ? '' : 'active'}" 
                     onclick="toggleCollapse('${className}')">
                    ${className}
                    <span class="student-count">${students.length}äºº</span>
                </div>
                <div class="scrollable-container" 
                     id="${className}-content"
                     style="max-height: ${collapseState ? '0' : '70vh'}">
                    <table>
                        <thead><tr><th>å§“å</th><th>ç§¯åˆ†</th><th>æ“ä½œ</th></tr></thead>
                        <tbody>
                            ${students.map((s, i) => `
                            <tr>
                                <td>${s.name}</td>
                                <td>${s.score}åˆ†</td>
                                <td>
                                    <button class="score-btn" style="background:#27ae60" 
                                        onclick="adjustScore('${className}', ${i}, 1)">+1</button>
                                    <button class="score-btn" style="background:#e74c3c" 
                                        onclick="adjustScore('${className}', ${i}, -1)">-1</button>
                                    <button class="score-btn" 
                                        onclick="deleteStudent('${className}', ${i})">åˆ é™¤</button>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        });
        html += '</div>';
    });
    document.getElementById('gradeContainer').innerHTML = html;
}

// æŠ˜å åŠŸèƒ½
async function toggleCollapse(className) {
    const content = document.getElementById(`${className}-content`);
    const isExpanding = content.style.maxHeight === '0px' || !content.style.maxHeight;
    
    if (isExpanding) {
        content.style.maxHeight = `${content.scrollHeight}px`;
        setTimeout(() => {
            content.style.maxHeight = '70vh';
        }, 10);
    } else {
        content.style.maxHeight = '0';
    }

    classData[className].collapseState = !isExpanding;
    content.previousElementSibling.classList.toggle('active');
    await saveClassData(className);
}

// çª—å£å¤§å°å˜åŒ–ç›‘å¬
window.addEventListener('resize', () => {
    Object.keys(classData).forEach(className => {
        if (!classData[className].collapseState) {
            const content = document.getElementById(`${className}-content`);
            if (content) {
                content.style.maxHeight = '70vh';
                content.style.overflowY = 'hidden';
                setTimeout(() => {
                    content.style.overflowY = 'auto';
                }, 10);
            }
        }
    });
});

// åˆå§‹åŒ–åŠ è½½
document.addEventListener('DOMContentLoaded', () => {
    loadData().catch(e => {
        console.error('åˆå§‹åŒ–å¤±è´¥:', e);
        alert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
    });
});
</script>
</body>
</html>
